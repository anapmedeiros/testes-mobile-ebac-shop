"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getObjectId = getObjectId;
exports.getObjectSize = getObjectSize;
exports.requirePackage = requirePackage;

require("source-map-support/register");

var _system = require("./system");

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _uuid = require("uuid");

const ECMA_SIZES = Object.freeze({
  STRING: 2,
  BOOLEAN: 4,
  NUMBER: 8
});

async function linkGlobalPackage(packageName) {
  try {
    _logger.default.debug(`Linking package '${packageName}'`);

    const cmd = (0, _system.isWindows)() ? 'npm.cmd' : 'npm';
    await (0, _teen_process.exec)(cmd, ['link', packageName], {
      timeout: 20000
    });
  } catch (err) {
    const msg = `Unable to load package '${packageName}', linking failed: ${err.message}`;

    _logger.default.debug(msg);

    if (err.stderr) {
      _logger.default.debug(err.stderr);
    }

    throw new Error(msg);
  }
}

async function requirePackage(packageName) {
  try {
    _logger.default.debug(`Loading local package '${packageName}'`);

    return require(packageName);
  } catch (err) {
    _logger.default.debug(`Failed to load local package '${packageName}': ${err.message}`);
  }

  try {
    const globalPackageName = _path.default.resolve(process.env.npm_config_prefix, 'lib', 'node_modules', packageName);

    _logger.default.debug(`Loading global package '${globalPackageName}'`);

    return require(globalPackageName);
  } catch (err) {
    _logger.default.debug(`Failed to load global package '${packageName}': ${err.message}`);
  }

  try {
    await linkGlobalPackage(packageName);

    _logger.default.debug(`Retrying load of linked package '${packageName}'`);

    return require(packageName);
  } catch (err) {
    _logger.default.errorAndThrow(`Unable to load package '${packageName}': ${err.message}`);
  }
}

function extractAllProperties(obj) {
  const stringProperties = [];

  for (const prop in obj) {
    stringProperties.push(prop);
  }

  if (_lodash.default.isFunction(Object.getOwnPropertySymbols)) {
    stringProperties.push(...Object.getOwnPropertySymbols(obj));
  }

  return stringProperties;
}

function _getSizeOfObject(seen, object) {
  if (_lodash.default.isNil(object)) {
    return 0;
  }

  let bytes = 0;
  const properties = extractAllProperties(object);

  for (const key of properties) {
    if (typeof object[key] === 'object' && !_lodash.default.isNil(object[key])) {
      if (seen.has(object[key])) {
        continue;
      }

      seen.add(object[key]);
    }

    bytes += getCalculator(seen)(key);

    try {
      bytes += getCalculator(seen)(object[key]);
    } catch (ex) {
      if (ex instanceof RangeError) {
        bytes = 0;
      }
    }
  }

  return bytes;
}

function getCalculator(seen) {
  return function calculator(obj) {
    if (_lodash.default.isBuffer(obj)) {
      return obj.length;
    }

    switch (typeof obj) {
      case 'string':
        return obj.length * ECMA_SIZES.STRING;

      case 'boolean':
        return ECMA_SIZES.BOOLEAN;

      case 'number':
        return ECMA_SIZES.NUMBER;

      case 'symbol':
        return _lodash.default.isFunction(Symbol.keyFor) && Symbol.keyFor(obj) ? Symbol.keyFor(obj).length * ECMA_SIZES.STRING : (obj.toString().length - 8) * ECMA_SIZES.STRING;

      case 'object':
        return _lodash.default.isArray(obj) ? obj.map(getCalculator(seen)).reduce((acc, curr) => acc + curr, 0) : _getSizeOfObject(seen, obj);

      default:
        return 0;
    }
  };
}

function getObjectSize(obj) {
  return getCalculator(new WeakSet())(obj);
}

const OBJECTS_MAPPING = new WeakMap();

function getObjectId(object) {
  if (!OBJECTS_MAPPING.has(object)) {
    OBJECTS_MAPPING.set(object, (0, _uuid.v4)());
  }

  return OBJECTS_MAPPING.get(object);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9ub2RlLmpzIl0sIm5hbWVzIjpbIkVDTUFfU0laRVMiLCJPYmplY3QiLCJmcmVlemUiLCJTVFJJTkciLCJCT09MRUFOIiwiTlVNQkVSIiwibGlua0dsb2JhbFBhY2thZ2UiLCJwYWNrYWdlTmFtZSIsImxvZyIsImRlYnVnIiwiY21kIiwidGltZW91dCIsImVyciIsIm1zZyIsIm1lc3NhZ2UiLCJzdGRlcnIiLCJFcnJvciIsInJlcXVpcmVQYWNrYWdlIiwicmVxdWlyZSIsImdsb2JhbFBhY2thZ2VOYW1lIiwicGF0aCIsInJlc29sdmUiLCJwcm9jZXNzIiwiZW52IiwibnBtX2NvbmZpZ19wcmVmaXgiLCJlcnJvckFuZFRocm93IiwiZXh0cmFjdEFsbFByb3BlcnRpZXMiLCJvYmoiLCJzdHJpbmdQcm9wZXJ0aWVzIiwicHJvcCIsInB1c2giLCJfIiwiaXNGdW5jdGlvbiIsImdldE93blByb3BlcnR5U3ltYm9scyIsIl9nZXRTaXplT2ZPYmplY3QiLCJzZWVuIiwib2JqZWN0IiwiaXNOaWwiLCJieXRlcyIsInByb3BlcnRpZXMiLCJrZXkiLCJoYXMiLCJhZGQiLCJnZXRDYWxjdWxhdG9yIiwiZXgiLCJSYW5nZUVycm9yIiwiY2FsY3VsYXRvciIsImlzQnVmZmVyIiwibGVuZ3RoIiwiU3ltYm9sIiwia2V5Rm9yIiwidG9TdHJpbmciLCJpc0FycmF5IiwibWFwIiwicmVkdWNlIiwiYWNjIiwiY3VyciIsImdldE9iamVjdFNpemUiLCJXZWFrU2V0IiwiT0JKRUNUU19NQVBQSU5HIiwiV2Vha01hcCIsImdldE9iamVjdElkIiwic2V0IiwiZ2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsVUFBVSxHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUMvQkMsRUFBQUEsTUFBTSxFQUFFLENBRHVCO0FBRS9CQyxFQUFBQSxPQUFPLEVBQUUsQ0FGc0I7QUFHL0JD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Y2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc1dpbmRvd3MgfSBmcm9tICcuL3N5c3RlbSc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZFY0IH0gZnJvbSAndXVpZCc7XG5cbmNvbnN0IEVDTUFfU0laRVMgPSBPYmplY3QuZnJlZXplKHtcbiAgU1RSSU5HOiAyLFxuICBCT09MRUFOOiA0LFxuICBOVU1CRVI6IDgsXG59KTtcblxuLyoqXG4gKiBJbnRlcm5hbCB1dGlsaXR5IHRvIGxpbmsgZ2xvYmFsIHBhY2thZ2UgdG8gbG9jYWwgY29udGV4dFxuICpcbiAqIEByZXR1cm5zIHtzdHJpbmd9IC0gbmFtZSBvZiB0aGUgcGFja2FnZSB0byBsaW5rXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIGNvbW1hbmQgZmFpbHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gbGlua0dsb2JhbFBhY2thZ2UgKHBhY2thZ2VOYW1lKSB7XG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKGBMaW5raW5nIHBhY2thZ2UgJyR7cGFja2FnZU5hbWV9J2ApO1xuICAgIGNvbnN0IGNtZCA9IGlzV2luZG93cygpID8gJ25wbS5jbWQnIDogJ25wbSc7XG4gICAgYXdhaXQgZXhlYyhjbWQsIFsnbGluaycsIHBhY2thZ2VOYW1lXSwge3RpbWVvdXQ6IDIwMDAwfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnN0IG1zZyA9IGBVbmFibGUgdG8gbG9hZCBwYWNrYWdlICcke3BhY2thZ2VOYW1lfScsIGxpbmtpbmcgZmFpbGVkOiAke2Vyci5tZXNzYWdlfWA7XG4gICAgbG9nLmRlYnVnKG1zZyk7XG4gICAgaWYgKGVyci5zdGRlcnIpIHtcbiAgICAgIC8vIGxvZyB0aGUgc3RkZXJyIGlmIHRoZXJlLCBidXQgZG8gbm90IGFkZCB0byB0aHJvd24gZXJyb3IgYXMgaXQgaXNcbiAgICAgIC8vIF92ZXJ5XyB2ZXJib3NlXG4gICAgICBsb2cuZGVidWcoZXJyLnN0ZGVycik7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihtc2cpO1xuICB9XG59XG5cbi8qKlxuICogVXRpbGl0eSBmdW5jdGlvbiB0byBleHRlbmQgbm9kZSBmdW5jdGlvbmFsaXR5LCBhbGxvd2luZyB1cyB0byByZXF1aXJlXG4gKiBtb2R1bGVzIHRoYXQgYXJlIGluc3RhbGxlZCBnbG9iYWxseS4gSWYgdGhlIHBhY2thZ2UgY2Fubm90IGJlIHJlcXVpcmVkLFxuICogdGhpcyB3aWxsIGF0dGVtcHQgdG8gbGluayB0aGUgcGFja2FnZSBhbmQgdGhlbiByZS1yZXF1aXJlIGl0XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHBhY2thZ2VOYW1lIC0gdGhlIG5hbWUgb2YgdGhlIHBhY2thZ2UgdG8gYmUgcmVxdWlyZWRcbiAqIEByZXR1cm5zIHtvYmplY3R9IC0gdGhlIHBhY2thZ2Ugb2JqZWN0XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlIHBhY2thZ2UgaXMgbm90IGZvdW5kIGxvY2FsbHkgb3IgZ2xvYmFsbHlcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcmVxdWlyZVBhY2thZ2UgKHBhY2thZ2VOYW1lKSB7XG4gIC8vIGZpcnN0LCBnZXQgaXQgaW4gdGhlIG5vcm1hbCB3YXkgKHNlZSBodHRwczovL25vZGVqcy5vcmcvYXBpL21vZHVsZXMuaHRtbCNtb2R1bGVzX2FsbF90b2dldGhlcilcbiAgdHJ5IHtcbiAgICBsb2cuZGVidWcoYExvYWRpbmcgbG9jYWwgcGFja2FnZSAnJHtwYWNrYWdlTmFtZX0nYCk7XG4gICAgcmV0dXJuIHJlcXVpcmUocGFja2FnZU5hbWUpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYEZhaWxlZCB0byBsb2FkIGxvY2FsIHBhY2thZ2UgJyR7cGFja2FnZU5hbWV9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIHNlY29uZCwgZ2V0IGl0IGZyb20gd2hlcmUgaXQgb3VnaHQgdG8gYmUgaW4gdGhlIGdsb2JhbCBub2RlX21vZHVsZXNcbiAgdHJ5IHtcbiAgICBjb25zdCBnbG9iYWxQYWNrYWdlTmFtZSA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmVudi5ucG1fY29uZmlnX3ByZWZpeCwgJ2xpYicsICdub2RlX21vZHVsZXMnLCBwYWNrYWdlTmFtZSk7XG4gICAgbG9nLmRlYnVnKGBMb2FkaW5nIGdsb2JhbCBwYWNrYWdlICcke2dsb2JhbFBhY2thZ2VOYW1lfSdgKTtcbiAgICByZXR1cm4gcmVxdWlyZShnbG9iYWxQYWNrYWdlTmFtZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhgRmFpbGVkIHRvIGxvYWQgZ2xvYmFsIHBhY2thZ2UgJyR7cGFja2FnZU5hbWV9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIHRoaXJkLCBsaW5rIHRoZSBmaWxlIGFuZCBnZXQgbG9jYWxseVxuICB0cnkge1xuICAgIGF3YWl0IGxpbmtHbG9iYWxQYWNrYWdlKHBhY2thZ2VOYW1lKTtcbiAgICBsb2cuZGVidWcoYFJldHJ5aW5nIGxvYWQgb2YgbGlua2VkIHBhY2thZ2UgJyR7cGFja2FnZU5hbWV9J2ApO1xuICAgIHJldHVybiByZXF1aXJlKHBhY2thZ2VOYW1lKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFVuYWJsZSB0byBsb2FkIHBhY2thZ2UgJyR7cGFja2FnZU5hbWV9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBleHRyYWN0QWxsUHJvcGVydGllcyAob2JqKSB7XG4gIGNvbnN0IHN0cmluZ1Byb3BlcnRpZXMgPSBbXTtcbiAgZm9yIChjb25zdCBwcm9wIGluIG9iaikge1xuICAgIHN0cmluZ1Byb3BlcnRpZXMucHVzaChwcm9wKTtcbiAgfVxuICBpZiAoXy5pc0Z1bmN0aW9uKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpKSB7XG4gICAgc3RyaW5nUHJvcGVydGllcy5wdXNoKC4uLihPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKG9iaikpKTtcbiAgfVxuICByZXR1cm4gc3RyaW5nUHJvcGVydGllcztcbn1cblxuZnVuY3Rpb24gX2dldFNpemVPZk9iamVjdCAoc2Vlbiwgb2JqZWN0KSB7XG4gIGlmIChfLmlzTmlsKG9iamVjdCkpIHtcbiAgICByZXR1cm4gMDtcbiAgfVxuXG4gIGxldCBieXRlcyA9IDA7XG4gIGNvbnN0IHByb3BlcnRpZXMgPSBleHRyYWN0QWxsUHJvcGVydGllcyhvYmplY3QpO1xuICBmb3IgKGNvbnN0IGtleSBvZiBwcm9wZXJ0aWVzKSB7XG4gICAgLy8gRG8gbm90IHJlY2FsY3VsYXRlIGNpcmN1bGFyIHJlZmVyZW5jZXNcbiAgICBpZiAodHlwZW9mIG9iamVjdFtrZXldID09PSAnb2JqZWN0JyAmJiAhXy5pc05pbChvYmplY3Rba2V5XSkpIHtcbiAgICAgIGlmIChzZWVuLmhhcyhvYmplY3Rba2V5XSkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBzZWVuLmFkZChvYmplY3Rba2V5XSk7XG4gICAgfVxuXG4gICAgYnl0ZXMgKz0gZ2V0Q2FsY3VsYXRvcihzZWVuKShrZXkpO1xuICAgIHRyeSB7XG4gICAgICBieXRlcyArPSBnZXRDYWxjdWxhdG9yKHNlZW4pKG9iamVjdFtrZXldKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgaWYgKGV4IGluc3RhbmNlb2YgUmFuZ2VFcnJvcikge1xuICAgICAgICAvLyBjaXJjdWxhciByZWZlcmVuY2UgZGV0ZWN0ZWQsIGZpbmFsIHJlc3VsdCBtaWdodCBiZSBpbmNvcnJlY3RcbiAgICAgICAgLy8gbGV0J3MgYmUgbmljZSBhbmQgbm90IHRocm93IGFuIGV4Y2VwdGlvblxuICAgICAgICBieXRlcyA9IDA7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGJ5dGVzO1xufVxuXG5mdW5jdGlvbiBnZXRDYWxjdWxhdG9yIChzZWVuKSB7XG4gIHJldHVybiBmdW5jdGlvbiBjYWxjdWxhdG9yIChvYmopIHtcbiAgICBpZiAoXy5pc0J1ZmZlcihvYmopKSB7XG4gICAgICByZXR1cm4gb2JqLmxlbmd0aDtcbiAgICB9XG5cbiAgICBzd2l0Y2ggKHR5cGVvZiAob2JqKSkge1xuICAgICAgY2FzZSAnc3RyaW5nJzpcbiAgICAgICAgcmV0dXJuIG9iai5sZW5ndGggKiBFQ01BX1NJWkVTLlNUUklORztcbiAgICAgIGNhc2UgJ2Jvb2xlYW4nOlxuICAgICAgICByZXR1cm4gRUNNQV9TSVpFUy5CT09MRUFOO1xuICAgICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgICAgcmV0dXJuIEVDTUFfU0laRVMuTlVNQkVSO1xuICAgICAgY2FzZSAnc3ltYm9sJzpcbiAgICAgICAgcmV0dXJuIF8uaXNGdW5jdGlvbihTeW1ib2wua2V5Rm9yKSAmJiBTeW1ib2wua2V5Rm9yKG9iailcbiAgICAgICAgICA/IFN5bWJvbC5rZXlGb3Iob2JqKS5sZW5ndGggKiBFQ01BX1NJWkVTLlNUUklOR1xuICAgICAgICAgIDogKG9iai50b1N0cmluZygpLmxlbmd0aCAtIDgpICogRUNNQV9TSVpFUy5TVFJJTkc7XG4gICAgICBjYXNlICdvYmplY3QnOlxuICAgICAgICByZXR1cm4gXy5pc0FycmF5KG9iailcbiAgICAgICAgICA/IG9iai5tYXAoZ2V0Q2FsY3VsYXRvcihzZWVuKSkucmVkdWNlKChhY2MsIGN1cnIpID0+IGFjYyArIGN1cnIsIDApXG4gICAgICAgICAgOiBfZ2V0U2l6ZU9mT2JqZWN0KHNlZW4sIG9iaik7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gMDtcbiAgICB9XG4gIH07XG59XG5cbi8qKlxuICogQ2FsY3VsYXRlIHRoZSBpbi1kZXB0aCBzaXplIGluIG1lbW9yeSBvZiB0aGUgcHJvdmlkZWQgb2JqZWN0LlxuICogVGhlIG9yaWdpbmFsIGltcGxlbWVudGF0aW9uIGlzIGJvcnJvd2VkIGZyb20gaHR0cHM6Ly9naXRodWIuY29tL21pa3RhbS9zaXplb2YuXG4gKlxuICogQHBhcmFtIHsqfSBvYmogQW4gb2JqZWN0IHdob3NlIHNpemUgc2hvdWxkIGJlIGNhbGN1bGF0ZWRcbiAqIEByZXR1cm5zIHtudW1iZXJ9IE9iamVjdCBzaXplIGluIGJ5dGVzLlxuICovXG5mdW5jdGlvbiBnZXRPYmplY3RTaXplIChvYmopIHtcbiAgcmV0dXJuIGdldENhbGN1bGF0b3IobmV3IFdlYWtTZXQoKSkob2JqKTtcbn1cblxuY29uc3QgT0JKRUNUU19NQVBQSU5HID0gbmV3IFdlYWtNYXAoKTtcblxuLyoqXG4gKiBDYWxjdWxhdGVzIGEgdW5pcXVlIG9iamVjdCBpZGVudGlmaWVyXG4gKlxuICogQHBhcmFtIHtvYmplY3R9IG9iamVjdCBBbnkgdmFsaWQgRUNNQSBvYmplY3RcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEEgdXVpZFY0IHN0cmluZyB0aGF0IHVuaXF1ZWx5IGlkZW50aWZpZXMgZ2l2ZW4gb2JqZWN0XG4gKi9cbmZ1bmN0aW9uIGdldE9iamVjdElkIChvYmplY3QpIHtcbiAgaWYgKCFPQkpFQ1RTX01BUFBJTkcuaGFzKG9iamVjdCkpIHtcbiAgICBPQkpFQ1RTX01BUFBJTkcuc2V0KG9iamVjdCwgdXVpZFY0KCkpO1xuICB9XG4gIHJldHVybiBPQkpFQ1RTX01BUFBJTkcuZ2V0KG9iamVjdCk7XG59XG5cbmV4cG9ydCB7IHJlcXVpcmVQYWNrYWdlLCBnZXRPYmplY3RTaXplLCBnZXRPYmplY3RJZCB9O1xuIl19